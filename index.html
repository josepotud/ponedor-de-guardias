<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Guardias - Edición Avanzada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 0.8rem; user-select: none; cursor: pointer; transition: all 0.1s; position: relative; }
        .day-standard:hover { background-color: #DBEAFE; transform: scale(1.05); }
        
        .day-blocked { background-color: #EF4444; color: white; }
        .day-suggested { background-color: #10B981; color: white; }
        .day-holiday { background-color: #F59E0B; color: white; font-weight: bold; border: 2px solid #D97706; }
        
        .day-multi-staff { background-color: #1E3A8A; color: white; font-weight: bold; }
        .day-multi-staff .badge { position: absolute; bottom: 2px; right: 2px; font-size: 0.7em; background: rgba(0,0,0,0.3); padding: 0 4px; border-radius: 4px; }
        
        .day-disabled { background-color: #F3F4F6; color: #D1D5DB; cursor: not-allowed; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <!-- Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-60 z-[60] hidden flex-col items-center justify-center text-white backdrop-blur-sm">
        <div class="loader mb-4"></div>
        <p class="font-bold text-lg" id="loadingTitle">Procesando...</p>
        <p class="text-sm opacity-80" id="loadingSubtitle">Calculando distribución</p>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-lg md:text-xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-edit mr-2 text-blue-600"></i>
                <span class="hidden md:inline">Gestor de Guardias Pro</span>
                <span class="md:hidden">Guardias</span>
            </h1>
            <div class="flex gap-2">
                <button onclick="document.getElementById('historyInput').click()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-2 rounded border border-purple-300 transition text-sm font-bold flex items-center" title="Importar JSON Contable">
                    <i class="fas fa-upload mr-2"></i> Histórico
                </button>
                <input type="file" id="historyInput" class="hidden" accept=".json" onchange="importHistory(this)">
                
                <div class="h-8 w-px bg-gray-300 mx-1"></div>

                <button onclick="exportData()" class="text-gray-600 hover:bg-gray-100 p-2 rounded" title="Guardar Copia de Seguridad (Estado actual)"><i class="fas fa-save"></i></button>
                <button onclick="triggerImport()" class="text-gray-600 hover:bg-gray-100 p-2 rounded" title="Restaurar Copia"><i class="fas fa-folder-open"></i></button>
                <input type="file" id="fileInput" class="hidden" accept=".json" onchange="importData(this)">
                <button onclick="resetData()" class="text-red-500 hover:bg-red-50 p-2 rounded" title="Reset Total"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Config -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                <h2 class="font-bold text-gray-700 mb-4 border-b pb-2">1. Configuración</h2>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">INICIO</label>
                        <input type="date" id="startDate" class="border p-2 rounded text-sm w-full outline-none focus:ring-2 focus:ring-blue-200" onchange="saveStateInputs()">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">FIN</label>
                        <input type="date" id="endDate" class="border p-2 rounded text-sm w-full outline-none focus:ring-2 focus:ring-blue-200" onchange="saveStateInputs()">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openHolidayModal()" class="text-xs bg-orange-100 text-orange-700 px-2 py-2 rounded hover:bg-orange-200 transition flex justify-center items-center font-bold">
                        <i class="fas fa-umbrella-beach mr-1"></i> Festivos
                    </button>
                    <button onclick="openStaffingModal()" class="text-xs bg-blue-100 text-blue-700 px-2 py-2 rounded hover:bg-blue-200 transition flex justify-center items-center font-bold">
                        <i class="fas fa-users mr-1"></i> Plazas (N)
                    </button>
                </div>
            </div>

            <div class="bg-white p-5 rounded-lg shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="font-bold text-gray-700">2. Personal</h2>
                    <span id="historyBadge" class="hidden text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold">Historial OK</span>
                </div>
                
                <div class="space-y-3 mb-4 bg-gray-50 p-3 rounded-md border border-gray-100">
                    <input type="text" id="newPersonName" placeholder="Nombre" class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none">
                    <div class="flex gap-2">
                         <input type="number" id="newPersonMin" placeholder="Mín" class="w-1/2 border p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none">
                         <input type="number" id="newPersonMax" placeholder="Máx" class="w-1/2 border p-2 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none">
                    </div>
                    <div class="flex items-center justify-between pt-1">
                        <label class="flex items-center cursor-pointer select-none">
                            <input type="checkbox" id="newPersonDoublets" class="h-4 w-4 text-blue-600 rounded">
                            <span class="ml-2 text-xs text-gray-600 font-medium">Acepta Dobletes</span>
                        </label>
                        <button onclick="addPerson()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-xs font-bold uppercase tracking-wide transition shadow-sm">
                            Añadir
                        </button>
                    </div>
                </div>
                <div id="peopleList" class="space-y-2 max-h-[400px] overflow-y-auto pr-1"></div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="startGeneration(false)" class="w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white font-bold py-4 rounded-lg shadow-lg transform transition active:scale-95 flex flex-col items-center justify-center">
                    <span class="text-sm"><i class="fas fa-magic mr-1"></i>Generar Todo</span>
                    <span class="text-xs font-normal opacity-80">(Borra actual)</span>
                </button>
                <button onclick="startGeneration(true)" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-700 hover:to-blue-600 text-white font-bold py-4 rounded-lg shadow-lg transform transition active:scale-95 flex flex-col items-center justify-center">
                    <span class="text-sm"><i class="fas fa-fill-drip mr-1"></i>Rellenar Huecos</span>
                    <span class="text-xs font-normal opacity-80">(Respeta asignados)</span>
                </button>
            </div>
        </div>

        <!-- Results -->
        <div class="lg:col-span-2 space-y-6">
            
            <div id="statsPanel" class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 hidden">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <div>
                        <h2 class="font-bold text-gray-700 text-lg">Resultados (Acumulado)</h2>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="downloadReportJSON()" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-4 py-2 rounded font-bold transition shadow-sm flex items-center" title="Descargar contabilidad para futuro">
                            <i class="fas fa-file-invoice-dollar mr-2"></i> Contabilidad (JSON)
                        </button>
                        <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white text-xs px-4 py-2 rounded font-bold transition shadow-sm flex items-center">
                            <i class="fas fa-file-pdf mr-2"></i> PDF
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded border border-gray-100">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-600 font-bold border-b">
                            <tr>
                                <th class="px-4 py-3">Nombre</th>
                                <th class="px-4 py-3 text-center bg-gray-100">Total</th>
                                <th class="px-4 py-3 text-center text-teal-600" title="Viernes y Vísperas">Vier+Vís</th>
                                <th class="px-4 py-3 text-center text-purple-600" title="Sábados y Domingos">S-D</th>
                                <th class="px-4 py-3 text-center text-orange-600" title="Festivos">Festivos</th>
                            </tr>
                        </thead>
                        <tbody id="statsBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>

            <div id="scheduleResult" class="bg-white p-5 rounded-lg shadow-sm border border-gray-200 hidden">
                <div id="alertBox" class="hidden mb-4 p-4 bg-red-50 text-red-700 text-sm font-medium rounded border border-red-200 flex items-start">
                    <i class="fas fa-exclamation-triangle mt-0.5 mr-2"></i>
                    <span id="alertText"></span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-gray-700">Calendario Generado</h3>
                    <div class="text-xs text-gray-400 italic">Pulsa la papelera para liberar un día y "Rellenar" para recalcularlo.</div>
                </div>
                <div class="overflow-x-auto max-h-[500px] rounded border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-500 font-bold sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-6 py-3 border-b bg-gray-50">Fecha</th>
                                <th class="px-6 py-3 border-b bg-gray-50">Tipo</th>
                                <th class="px-6 py-3 border-b bg-gray-50">Asignado</th>
                                <th class="px-6 py-3 border-b bg-gray-50 text-center">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="scheduleBody" class="divide-y divide-gray-100 bg-white"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="emptyState" class="flex flex-col items-center justify-center h-64 text-gray-300 bg-white rounded-lg border-2 border-dashed border-gray-200">
                <i class="fas fa-calendar-alt text-6xl mb-4 opacity-20"></i>
                <p class="font-medium text-gray-400">Configura y calcula</p>
            </div>
        </div>
    </main>

    <!-- Calendar Modal -->
    <div id="calendarModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                <h3 id="modalTitle" class="font-bold text-gray-800">Calendario</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="personModalControls" class="flex justify-center p-2 gap-4 hidden bg-white border-b border-gray-100">
                <label class="flex items-center text-xs font-bold cursor-pointer">
                    <input type="radio" name="dayAction" value="block" checked class="text-red-500 mr-1" onchange="renderCalendar()"> 
                    <span class="text-red-500">Bloquear</span>
                </label>
                <label class="flex items-center text-xs font-bold cursor-pointer">
                    <input type="radio" name="dayAction" value="suggest" class="text-green-500 mr-1" onchange="renderCalendar()"> 
                    <span class="text-green-500">Sugerir (Fijo)</span>
                </label>
            </div>
            <!-- Staffing Hints -->
            <div id="staffingControls" class="hidden text-center text-xs text-gray-500 bg-blue-50 p-2">
                Click Izq: +1 | Click Der: -1
            </div>
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="p-1"><i class="fas fa-chevron-left"></i></button>
                    <span id="monthLabel" class="font-bold text-gray-700 capitalize"></span>
                    <button onclick="changeMonth(1)" class="p-1"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-xs font-bold text-gray-400 mb-2">
                    <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
            <div class="bg-gray-50 p-3 flex justify-end">
                <button onclick="closeModal()" class="bg-gray-800 text-white px-5 py-2 rounded text-sm font-bold">Hecho</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let appData = { startDate: '', endDate: '', holidays: [], staffing: {}, people: [], schedule: [], history: {}, importedFiles: [] };
        let viewDate = new Date();
        let modalMode = 'block'; 
        let currentPersonId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            if(!appData.startDate) {
                const today = new Date();
                const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
                const endMonth = new Date(today.getFullYear(), today.getMonth() + 2, 0);
                appData.startDate = nextMonth.toISOString().split('T')[0];
                appData.endDate = endMonth.toISOString().split('T')[0];
                saveState();
            }
            document.getElementById('startDate').value = appData.startDate;
            document.getElementById('endDate').value = appData.endDate;
            renderPeople();
            updateHistoryBadge();
            if(appData.schedule.length > 0) renderResults(0);
        });

        function saveStateInputs() {
            appData.startDate = document.getElementById('startDate').value;
            appData.endDate = document.getElementById('endDate').value;
            saveState();
        }

        function updateHistoryBadge() {
            const count = Object.keys(appData.history || {}).length;
            const badge = document.getElementById('historyBadge');
            count > 0 ? badge.classList.remove('hidden') : badge.classList.add('hidden');
        }

        // --- HISTORY IMPORT ---
        function importHistory(el) {
            const f = el.files[0]; if(!f) return;
            // Prevent duplicate file import (basic check by name)
            if(appData.importedFiles && appData.importedFiles.includes(f.name)) {
                if(!confirm(`Parece que ya has importado "${f.name}". ¿Quieres importarlo de nuevo y sumar los datos?`)) {
                    el.value = ''; return;
                }
            }

            const r = new FileReader();
            r.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!data.resumen_personal) throw new Error();
                    if(!appData.history) appData.history = {};
                    if(!appData.importedFiles) appData.importedFiles = [];
                    
                    const start = new Date(data.periodo.inicio);
                    const end = new Date(data.periodo.fin);
                    const monthsInFile = Math.max(1, (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1);

                    data.resumen_personal.forEach(p => {
                        const pid = p.id_persona || p.nombre;
                        if(!appData.history[pid]) appData.history[pid] = { name: p.nombre, months:0, total:0, hol:0, sd:0, fri:0 };
                        const h = appData.history[pid];
                        h.total += p.estadisticas.total_guardias;
                        h.hol += p.estadisticas.desglose.festivos;
                        h.sd += p.estadisticas.desglose.fin_de_semana;
                        h.fri += p.estadisticas.desglose.viernes_visperas;
                        h.months += monthsInFile; 
                    });
                    
                    appData.importedFiles.push(f.name);
                    saveState();
                    updateHistoryBadge();
                    renderPeople();
                    Swal.fire('OK', 'Historial importado', 'success');
                } catch(err) { Swal.fire('Error', 'Archivo no válido', 'error'); }
            };
            r.readAsText(f);
            el.value='';
        }

        // --- PEOPLE ---
        function addPerson() {
            const name = document.getElementById('newPersonName').value.trim();
            if (!name) return;
            let existingId = null;
            if(appData.history) {
                const found = Object.keys(appData.history).find(k => appData.history[k].name === name);
                if(found) existingId = found;
            }
            appData.people.push({
                id: existingId || Date.now().toString(),
                name,
                min: document.getElementById('newPersonMin').value,
                max: document.getElementById('newPersonMax').value,
                doublets: document.getElementById('newPersonDoublets').checked,
                blocked: [],
                suggested: []
            });
            // Cleanup
            document.getElementById('newPersonName').value = '';
            document.getElementById('newPersonMin').value = '';
            document.getElementById('newPersonMax').value = '';
            document.getElementById('newPersonDoublets').checked = false;
            document.getElementById('newPersonName').focus();
            
            saveState();
            renderPeople();
        }

        function removePerson(id) {
            appData.people = appData.people.filter(p => p.id !== id);
            saveState();
            renderPeople();
        }

        function renderPeople() {
            const list = document.getElementById('peopleList');
            list.innerHTML = '';
            appData.people.forEach(p => {
                const h = appData.history && appData.history[p.id];
                const el = document.createElement('div');
                el.className = "flex justify-between items-center bg-white p-3 rounded-lg border border-gray-200 hover:shadow-md transition";
                
                const infoHtml = h ? `<span class="text-xs text-purple-600 bg-purple-50 px-1 rounded ml-2">Hist:${h.total}</span>` : `<span class="text-xs text-green-600 bg-green-50 px-1 rounded ml-2">Nuevo</span>`;
                const blk = p.blocked.length, sug = p.suggested ? p.suggested.length : 0;

                el.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-bold text-gray-800 text-sm flex items-center">${p.name} ${infoHtml}</span>
                        <div class="flex gap-2 text-xs text-gray-500 mt-1">
                            ${p.doublets?'Doble:Sí':'Doble:No'} 
                            ${blk > 0 ? `<span class="text-red-500">Bloq:${blk}</span>` : ''}
                            ${sug > 0 ? `<span class="text-green-600 font-bold">Sug:${sug}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openPersonModal('${p.id}')" class="p-2 text-gray-400 hover:text-blue-500 rounded"><i class="fas fa-calendar-day"></i></button>
                        <button onclick="removePerson('${p.id}')" class="p-2 text-gray-400 hover:text-red-600 rounded"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        // --- CALENDAR UI ---
        function openPersonModal(id) { 
            modalMode='person'; 
            currentPersonId=id; 
            document.getElementById('modalTitle').innerText = appData.people.find(x=>x.id===id).name; 
            document.getElementById('personModalControls').classList.remove('hidden'); 
            document.getElementById('staffingControls').classList.add('hidden');
            const blockRadio = document.querySelector('input[name="dayAction"][value="block"]');
            if(blockRadio) blockRadio.checked = true;
            openModal(); 
        }
        function openHolidayModal() { 
            modalMode='holiday'; currentPersonId=null; 
            document.getElementById('modalTitle').innerText = 'Festivos'; 
            document.getElementById('personModalControls').classList.add('hidden'); 
            document.getElementById('staffingControls').classList.add('hidden');
            openModal(); 
        }
        function openStaffingModal() { 
            modalMode='staffing'; currentPersonId=null; 
            document.getElementById('modalTitle').innerText = 'Plazas por Día'; 
            document.getElementById('personModalControls').classList.add('hidden'); 
            document.getElementById('staffingControls').classList.remove('hidden');
            openModal(); 
        }
        function openModal() { document.getElementById('calendarModal').classList.remove('hidden'); document.getElementById('calendarModal').classList.add('flex'); if(appData.startDate) viewDate = new Date(appData.startDate); renderCalendar(); }
        function closeModal() { document.getElementById('calendarModal').classList.add('hidden'); document.getElementById('calendarModal').classList.remove('flex'); saveState(); renderPeople(); }
        
        function changeMonth(d) { 
            viewDate.setDate(1);
            viewDate.setMonth(viewDate.getMonth() + d); 
            renderCalendar(); 
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const label = document.getElementById('monthLabel');
            grid.innerHTML = '';
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            label.innerText = viewDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            
            const first = new Date(y, m, 1), last = new Date(y, m+1, 0);
            let offset = first.getDay() - 1; if(offset===-1) offset=6;
            
            for(let i=0; i<offset; i++) grid.innerHTML += `<div></div>`;

            let blockedArr=[], suggestedArr=[], holidaysArr=appData.holidays;
            if(modalMode==='person') { const p=appData.people.find(x=>x.id===currentPersonId); if(p){ blockedArr=p.blocked; suggestedArr=p.suggested||[]; } }

            const min = new Date(appData.startDate); min.setHours(0,0,0,0);
            const max = new Date(appData.endDate); max.setHours(0,0,0,0);

            for(let d=1; d<=last.getDate(); d++) {
                const cur = new Date(y, m, d); cur.setHours(0,0,0,0);
                const iso = cur.toISOString().split('T')[0];
                const div = document.createElement('div');
                div.innerText = d;
                
                if(cur < min || cur > max) { div.className = "calendar-day day-disabled"; } 
                else {
                    let cls = "day-standard bg-white border border-gray-100";
                    if(modalMode==='person') {
                        if(blockedArr.includes(iso)) cls="day-blocked";
                        else if(suggestedArr.includes(iso)) cls="day-suggested";
                        else if(holidaysArr.includes(iso)) cls="bg-orange-50 text-orange-400";
                    } else if(modalMode==='holiday' && holidaysArr.includes(iso)) cls="day-holiday";
                    else if(modalMode==='staffing') {
                        const count = appData.staffing[iso] || 1;
                        if (count > 1) {
                            cls="day-multi-staff";
                            div.innerHTML = `${d} <span class="badge">x${count}</span>`;
                        }
                    }

                    div.className = `calendar-day ${cls}`;
                    div.onclick = (e) => {
                        if(modalMode==='holiday') {
                            const idx = holidaysArr.indexOf(iso); if(idx>-1) holidaysArr.splice(idx,1); else holidaysArr.push(iso);
                            appData.holidays=holidaysArr;
                        } else if(modalMode==='staffing') {
                            let count = appData.staffing[iso] || 1;
                            count++;
                            appData.staffing[iso] = count;
                        } else if(modalMode==='person') {
                            const p=appData.people.find(x=>x.id===currentPersonId);
                            const action = document.querySelector('input[name="dayAction"]:checked').value;
                            if(action==='block') {
                                const idxB=p.blocked.indexOf(iso); if(idxB>-1)p.blocked.splice(idxB,1); else { p.blocked.push(iso); if(p.suggested){const idxS=p.suggested.indexOf(iso); if(idxS>-1)p.suggested.splice(idxS,1);} }
                            } else {
                                if(!p.suggested) p.suggested=[];
                                const idxS=p.suggested.indexOf(iso); if(idxS>-1)p.suggested.splice(idxS,1); else { p.suggested.push(iso); const idxB=p.blocked.indexOf(iso); if(idxB>-1)p.blocked.splice(idxB,1); }
                            }
                        }
                        renderCalendar();
                    };
                    if(modalMode === 'staffing') {
                        div.oncontextmenu = (e) => {
                            e.preventDefault();
                            let count = appData.staffing[iso] || 1;
                            if (count > 1) { count--; appData.staffing[iso] = count; renderCalendar(); }
                        };
                    }
                }
                grid.appendChild(div);
            }
        }

        // --- MANUAL EDITS ---
        function clearSlot(dateIso, pid) {
            // Find specific slot in schedule
            const slot = appData.schedule.find(s => s.date === dateIso && s.pid === pid);
            if(slot) {
                slot.pid = null;
                slot.name = null;
                saveState();
                renderResults(0); // Update UI
            }
        }

        // --- ALGORITHM ---
        function getDatesRange(s, e) {
            const a=[]; let c=new Date(s); const end=new Date(e);
            while(c<=end){ a.push(new Date(c)); c.setDate(c.getDate()+1); }
            return a;
        }

        function getDayType(d, iso) {
            if(appData.holidays.includes(iso)) return 'HOLIDAY';
            const tmr = new Date(d); tmr.setDate(tmr.getDate()+1);
            if(appData.holidays.includes(tmr.toISOString().split('T')[0])) return 'EVE';
            const w=d.getDay();
            if(w===0||w===6) return 'WEEKEND';
            if(w===5) return 'FRIDAY';
            return 'WEEKDAY';
        }

        function startGeneration(preserveExisting) {
            if(!appData.people.length) return Swal.fire('Error', 'Sin personal', 'error');
            saveStateInputs();
            
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingOverlay').classList.add('flex');
            
            if(preserveExisting) {
                document.getElementById('loadingTitle').innerText = "Rellenando Huecos...";
                document.getElementById('loadingSubtitle').innerText = "Manteniendo asignaciones fijas";
            } else {
                document.getElementById('loadingTitle').innerText = "Generando Calendario...";
                document.getElementById('loadingSubtitle').innerText = "Calculando desde cero";
            }

            // Sanitize suggestions
            appData.people.forEach(p => {
                if(p.suggested && p.suggested.length > 1) {
                    p.suggested.sort();
                    for(let i = p.suggested.length - 1; i > 0; i--) {
                        const d1 = new Date(p.suggested[i]);
                        const d2 = new Date(p.suggested[i-1]);
                        const diffTime = Math.abs(d1 - d2);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                        if(diffDays === 1) {
                            p.suggested.splice(i, 1); 
                        }
                    }
                }
            });

            setTimeout(() => {
                const dates = getDatesRange(appData.startDate, appData.endDate);
                const d1=new Date(appData.startDate), d2=new Date(appData.endDate);
                const curMonths = Math.max(1, (d2.getFullYear()-d1.getFullYear())*12 + (d2.getMonth()-d1.getMonth())+1);

                let bestRes = null, minU = Infinity, bestStd = Infinity;
                
                // If preserving, we run fewer iterations as search space is constrained
                const iterations = preserveExisting ? 50 : 150; 

                for(let i=0; i<iterations; i++) {
                    const res = runSimulation(dates, curMonths, preserveExisting ? appData.schedule : []);
                    if(res.unassigned < minU) { minU=res.unassigned; bestRes=res; bestStd=res.stdDev; }
                    else if(res.unassigned === minU && res.stdDev < bestStd) { bestRes=res; bestStd=res.stdDev; }
                }

                if(bestRes.unassigned > 0) {
                    fillGaps(bestRes.schedule, bestRes.statsRef, dates);
                    bestRes.unassigned = bestRes.schedule.filter(s => !s.pid).length;
                }

                appData.schedule = bestRes.schedule;
                saveState();
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.getElementById('loadingOverlay').classList.remove('flex');
                renderResults(bestRes.unassigned);
            }, 100);
        }

        function runSimulation(dates, curMonths, existingSchedule) {
            let schedule = [];
            let unassignedTotal = 0;
            
            // Reconstruct schedule if preserving
            // We need a way to look up existing assignments by date
            let fixedSlots = {}; 
            if(existingSchedule && existingSchedule.length > 0) {
                existingSchedule.forEach(s => {
                    if(s.pid) {
                        if(!fixedSlots[s.date]) fixedSlots[s.date] = [];
                        fixedSlots[s.date].push(s.pid);
                    }
                });
            }

            let stats = {};
            appData.people.forEach(p => {
                const h = (appData.history && appData.history[p.id]) || { months:0, total:0, hol:0, sd:0, fri:0 };
                stats[p.id] = {
                    id: p.id,
                    histTotal: h.total||0, histHol: h.hol||0, histSD: h.sd||0, histFri: h.fri||0,
                    curTotal: 0, curHol: 0, curSD: 0, curFri: 0,
                    lastIndex: -99, lastWkdIndex: -99,
                    totalMonths: (h.months||0) + curMonths
                };
            });

            for(let i=0; i<dates.length; i++) {
                const date = dates[i];
                const iso = date.toISOString().split('T')[0];
                const type = getDayType(date, iso);
                const isFriEve = (type==='FRIDAY'||type==='EVE');
                const isHigh = (type === 'HOLIDAY' || type === 'WEEKEND');
                
                const needed = appData.staffing[iso] || 1;
                
                let assignedToday = [];
                let slotsFilledByPreservation = 0;

                // 0. Pre-fill from Fixed Slots (Preservation Mode)
                if(fixedSlots[iso]) {
                    fixedSlots[iso].forEach(pid => {
                        // Validate person exists
                        const p = appData.people.find(x => x.id === pid);
                        if(p) {
                            assign(p.id, iso, type, i, isFriEve, stats, assignedToday);
                            slotsFilledByPreservation++;
                        }
                    });
                }

                // If fully filled by preservation, continue
                if(assignedToday.length >= needed) continue;

                // Calculate current Minimum Friday Count among all people to enforce balance
                let minFriCount = Infinity;
                Object.values(stats).forEach(s => { if (s.curFri < minFriCount) minFriCount = s.curFri; });

                // 1. Mandatory Suggestions
                appData.people.forEach(p => {
                    if (p.suggested && p.suggested.includes(iso)) {
                        if (assignedToday.length < needed && !assignedToday.includes(p.name)) {
                            assign(p.id, iso, type, i, isFriEve, stats, assignedToday);
                        }
                    }
                });

                // 2. Fill Slots
                while(assignedToday.length < needed) {
                    let pool = appData.people.filter(p => {
                        if(assignedToday.includes(p.name)) return false;
                        const s = stats[p.id];
                        if(p.blocked.includes(iso)) return false;
                        if(p.max && s.curTotal >= parseInt(p.max)) return false;
                        if((i - s.lastIndex) === 1) return false; 
                        if(!p.doublets && (i - s.lastIndex) === 2) return false;
                        if (isFriEve && s.curFri > minFriCount + 1) return false;
                        return true;
                    });

                    if(!pool.length) {
                        schedule.push({date:iso, pid:null, name:null, type, idx: i}); unassignedTotal++; break;
                    }

                    pool.forEach(p => {
                        const s = stats[p.id];
                        let score = 0;
                        const countHigh = s.histSD + s.curSD + s.histHol + s.curHol;
                        const countMid = s.histFri + s.curFri;
                        
                        if (isHigh) {
                            score += countHigh * 100000;
                            if((i - s.lastWkdIndex) < 6) score += 500000;
                        } 
                        else if (isFriEve) {
                            score += countMid * 50000;
                        } 
                        else {
                            score += s.curTotal * 5000;
                            const globalRatio = (s.histTotal + s.curTotal) / s.totalMonths;
                            score += globalRatio * 500;
                        }

                        if(p.min && s.curTotal < parseInt(p.min)) score -= 100000;
                        score += Math.random() * 100;
                        p.tempScore = score;
                    });

                    pool.sort((a,b) => a.tempScore - b.tempScore);
                    const winner = pool[0];
                    assign(winner.id, iso, type, i, isFriEve, stats, assignedToday);
                }
            }

            function assign(pid, iso, type, idx, isFriEve, st, todayList) {
                const p = appData.people.find(x => x.id === pid);
                const s = st[pid];
                s.curTotal++; s.lastIndex = idx;
                if(type==='HOLIDAY') s.curHol++;
                else if(type==='WEEKEND') { s.curSD++; s.lastWkdIndex = idx; }
                else if(isFriEve) s.curFri++;
                todayList.push(p.name);
                schedule.push({ date: iso, pid: p.id, name: p.name, type, idx });
            }

            const currents = Object.values(stats).map(s => s.curTotal);
            const mean = currents.reduce((a,b)=>a+b,0)/currents.length;
            const variance = currents.reduce((a,b)=>a + Math.pow(b-mean,2), 0)/currents.length;
            return { schedule, unassigned: unassignedTotal, stdDev: Math.sqrt(variance), statsRef: stats };
        }

        // --- GAP FILLING (SWAP LOGIC) ---
        function fillGaps(schedule, stats, dates) {
            let gaps = schedule.filter(s => s.pid === null);
            gaps.forEach(gap => {
                const dayIdx = gap.idx; 
                const candidates = appData.people.filter(p => !p.blocked.includes(gap.date));
                for (let p of candidates) {
                    const prevAssignment = schedule.find(s => s.idx === dayIdx - 1 && s.pid === p.id);
                    if (prevAssignment) {
                        const nextAssignment = schedule.find(s => s.idx === dayIdx + 1 && s.pid === p.id);
                        if (!nextAssignment) {
                            gap.pid = p.id; gap.name = p.name;
                            prevAssignment.pid = null; prevAssignment.name = null;
                            break; 
                        }
                    } else {
                        const prevAssign = schedule.find(s => s.idx === dayIdx - 1 && s.pid === p.id);
                        if(!prevAssign) { gap.pid = p.id; gap.name = p.name; break; }
                    }
                }
            });
        }

        // --- RENDER ---
        function renderResults(unassigned) {
            document.getElementById('statsPanel').classList.remove('hidden');
            document.getElementById('scheduleResult').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            const alert = document.getElementById('alertBox');
            if(unassigned > 0) { alert.classList.remove('hidden'); document.getElementById('alertText').innerText = `${unassigned} plazas sin cubrir.`; }
            else alert.classList.add('hidden');

            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            appData.schedule.sort((a,b) => a.date.localeCompare(b.date));
            let lastDate = '';
            appData.schedule.forEach(s => {
                const [y,m,d] = s.date.split('-');
                let cls="text-gray-400", bg="";
                if(s.type==='HOLIDAY') { cls="text-orange-700 font-bold"; bg="bg-orange-50"; }
                else if(s.type==='WEEKEND') { cls="text-purple-700 font-bold"; bg="bg-purple-50"; }
                else if(s.type==='EVE'||s.type==='FRIDAY') { cls="text-teal-600 font-bold"; }
                const border = (s.date !== lastDate) ? "border-t-2 border-gray-100" : "border-t-0 border-gray-50";
                lastDate = s.date;
                const tr = document.createElement('tr');
                tr.className = `hover:bg-blue-50 transition ${bg} ${border}`;
                
                let trashBtn = '';
                if(s.pid) {
                    trashBtn = `<button onclick="clearSlot('${s.date}', '${s.pid}')" class="text-gray-400 hover:text-red-500 transition px-2"><i class="fas fa-trash"></i></button>`;
                }

                tr.innerHTML = `
                    <td class="px-6 py-2">${d}/${m}</td>
                    <td class="px-6 py-2 ${cls}">${s.type}</td>
                    <td class="px-6 py-2 font-bold ${s.pid?'':'text-red-500'}">${s.name||'VACÍO'}</td>
                    <td class="px-6 py-2 text-center">${trashBtn}</td>
                `;
                tbody.appendChild(tr);
            });

            const allIds = new Set(appData.people.map(p=>p.id));
            if(appData.history) Object.keys(appData.history).forEach(k => allIds.add(k));
            const statsList = [];
            const d1=new Date(appData.startDate), d2=new Date(appData.endDate);
            const curMonths = Math.max(1, (d2.getFullYear()-d1.getFullYear())*12 + (d2.getMonth()-d1.getMonth())+1);

            allIds.forEach(id => {
                const activeP = appData.people.find(p => p.id === id);
                const h = (appData.history && appData.history[id]) || { total:0, hol:0, sd:0, fri:0, months:0, name: activeP ? activeP.name : 'Unknown' };
                let c = { t:0, h:0, s:0, f:0 };
                appData.schedule.filter(s => s.pid === id).forEach(s => {
                    c.t++;
                    if(s.type==='HOLIDAY') c.h++;
                    else if(s.type==='WEEKEND') c.s++;
                    else if(s.type==='FRIDAY'||s.type==='EVE') c.f++;
                });
                const name = activeP ? activeP.name : `${h.name} (Baja)`;
                const grandTotal = h.total + c.t; 
                statsList.push({ 
                    name, 
                    curTotal: c.t, 
                    grandTotal, 
                    fri: h.fri + c.f, 
                    sd: h.sd + c.s,
                    hol: h.hol + c.h,
                    isLeaver: !activeP 
                });
            });

            document.getElementById('statsBody').innerHTML = statsList.map(s => `
                <tr class="border-b ${s.isLeaver ? 'bg-gray-100 text-gray-500 italic' : ''}">
                    <td class="px-4 py-3 font-medium">${s.name}</td>
                    <td class="px-4 py-3 text-center font-bold bg-gray-100">${s.grandTotal}</td>
                    <td class="px-4 py-3 text-center text-teal-600">${s.fri}</td>
                    <td class="px-4 py-3 text-center text-purple-600">${s.sd}</td>
                    <td class="px-4 py-3 text-center text-orange-600 font-bold border-l border-gray-200">${s.hol}</td>
                </tr>
            `).join('');
        }

        // --- PDF ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // LANDSCAPE
            
            const startDate = new Date(appData.startDate);
            const endDate = new Date(appData.endDate);
            const monthName = startDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();

            doc.setFontSize(16);
            doc.text(`CALENDARIO DE GUARDIAS - ${monthName}`, 14, 15);
            
            const weeks = [];
            let currentWeek = new Array(7).fill(null);
            
            let iterDate = new Date(startDate);
            let startDay = iterDate.getDay() - 1; if(startDay === -1) startDay = 6;
            iterDate.setDate(iterDate.getDate() - startDay);

            while (iterDate <= endDate || currentWeek.some(d => d !== null)) {
                let dayIdx = iterDate.getDay() - 1; if (dayIdx === -1) dayIdx = 6;
                const iso = iterDate.toISOString().split('T')[0];
                const inRange = (iterDate >= startDate && iterDate <= endDate);
                
                if (inRange) {
                    const assigned = appData.schedule.filter(s => s.date === iso);
                    const dayNum = iterDate.getDate();
                    let content = `${dayNum}`;
                    if (assigned.length > 0) content += "\n" + assigned.map(a => a.name || "?").join("\n");
                    currentWeek[dayIdx] = content;
                } else if (currentWeek.some(d => d !== null) || iterDate < startDate) {
                    if(iterDate >= startDate || currentWeek.length > 0) currentWeek[dayIdx] = ""; 
                }

                if (dayIdx === 6) {
                    weeks.push(currentWeek);
                    currentWeek = new Array(7).fill(null);
                    if (iterDate > endDate) break;
                }
                iterDate.setDate(iterDate.getDate() + 1);
            }

            doc.autoTable({
                startY: 20,
                head: [['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo']],
                body: weeks,
                theme: 'grid',
                styles: { minCellHeight: 25, fontSize: 10, valign: 'top', halign: 'center', lineWidth: 0.1 },
                headStyles: { fillColor: [41, 128, 185], textColor: 255 },
                columnStyles: { 5: { fillColor: [240, 240, 250] }, 6: { fillColor: [240, 240, 250] } }
            });

            doc.addPage();
            doc.text("Resumen Contable (Cargas Separadas)", 14, 20);
            
            const rows = [];
            const allIds = new Set(appData.people.map(p=>p.id));
            if(appData.history) Object.keys(appData.history).forEach(k => allIds.add(k));

            allIds.forEach(id => {
                const activeP = appData.people.find(p => p.id === id);
                const h = (appData.history && appData.history[id]) || { total:0, hol:0, sd:0, fri:0, months:0, name: activeP ? activeP.name : 'Unknown' };
                let c = { t:0, h:0, s:0, f:0 };
                appData.schedule.filter(s=>s.pid===id).forEach(s=>{
                    c.t++; if(s.type==='HOLIDAY') c.h++; else if(s.type==='WEEKEND') c.s++; else if(s.type==='FRIDAY'||s.type==='EVE') c.f++;
                });
                
                rows.push([
                    activeP ? activeP.name : `${h.name} (Baja)`,
                    h.total+c.t,
                    h.fri+c.f,
                    h.sd+c.s,
                    h.hol+c.h 
                ]);
            });

            doc.autoTable({
                startY: 25,
                head: [['Nombre', 'Total Acum', 'Vier+Vís', 'Sáb+Dom', 'Fest']],
                body: rows,
                theme: 'striped'
            });

            doc.save('calendario_guardias.pdf');
        }

        // Utils
        function downloadReportJSON() {
            let report = { periodo: { inicio: appData.startDate, fin: appData.endDate }, generado: new Date().toISOString(), resumen_personal: [] };
            const allIds = new Set(appData.people.map(p=>p.id));
            if(appData.history) Object.keys(appData.history).forEach(k => allIds.add(k));
            allIds.forEach(id => {
                const activeP = appData.people.find(p => p.id === id);
                const h = (appData.history && appData.history[id]) || { total:0, hol:0, sd:0, fri:0, months:0, name: activeP ? activeP.name : 'Unknown' };
                const assignments = appData.schedule.filter(s => s.pid === id).map(s => ({ fecha: s.date, tipo: s.type }));
                let c = { t:0, h:0, s:0, f:0 };
                assignments.forEach(s => { c.t++; if(s.tipo==='HOLIDAY')c.h++; else if(s.tipo==='WEEKEND')c.s++; else if(s.tipo==='FRIDAY'||s.type==='EVE')c.f++; });
                report.resumen_personal.push({ id_persona: id, nombre: activeP ? activeP.name : h.name, estadisticas: { total_guardias: h.total+c.t, desglose: { festivos: h.hol+c.h, fin_de_semana: h.sd+c.s, viernes_visperas: h.fri+c.f, diario_LJ: 0 } } });
            });
            const blob = new Blob([JSON.stringify(report, null, 4)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `contabilidad_${appData.endDate}.json`; a.click();
        }
        function saveState() { localStorage.setItem('guardias', JSON.stringify(appData)); }
        function loadState() { const d = localStorage.getItem('guardias'); if(d) appData = { ...appData, ...JSON.parse(d) }; }
        function resetData() { if(confirm('¿Borrar?')) { localStorage.removeItem('guardias'); location.reload(); } }
        function exportData() { const blob = new Blob([JSON.stringify(appData)], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click(); }
        function triggerImport() { document.getElementById('fileInput').click(); }
        function importData(el) { const f = el.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { appData = JSON.parse(e.target.result); saveState(); location.reload(); }; r.readAsText(f); }
        function checkCookies() { if(!localStorage.getItem('okCookie')) document.getElementById('cookieBanner').classList.remove('hidden'); }
        function acceptCookies() { localStorage.setItem('okCookie','1'); document.getElementById('cookieBanner').classList.add('hidden'); }
    </script>
</body>
</html>
